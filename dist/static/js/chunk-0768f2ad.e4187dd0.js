(window["webpackJsonp_datastudio-web"]=window["webpackJsonp_datastudio-web"]||[]).push([["chunk-0768f2ad"],{"10f0":function(e,t,a){e.exports={globalFont:"Helvetica Neue,Helvetica,PingFang SC,Avenir,Segoe UI,Arial,sans-serif,Hiragino Sans GB,Microsoft YaHei",navbarHeight:"45px",menuText:"#445782",menuActiveText:"#3782ff",subMenuActiveText:"#3782ff",menuBg:"#f7f9ff",menuHover:"#dfebff",subMenuBg:"#1f2d3d",subMenuHover:"#dfebff",sideBarWidth:"244px"}},"23e3":function(e,t,a){},"4aa9":function(e,t,a){"use strict";a("505e")},"505e":function(e,t,a){},"53d2":function(e,t,a){},"566b":function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"container"},[a("div",{staticClass:"menu"},[a("div",{staticClass:"menu-left"},[a("a",{on:{click:e.close}},[e._v("工作流列表")]),e._v("\n      / "+e._s(e.workflowId?e.formData.name:"新建工作流")+"\n      "),a("span",{staticClass:"graph-tips"},[e._v("\n        画布说明\n        "),a("el-tooltip",{attrs:{effect:"dark","popper-class":"tooltip-width",placement:"top",content:"画布中的虚线边框节点代表的是依赖任务/数据集，它不属于此工作流管理，工作流不会调度/执行它"}},[a("i",{staticClass:"el-icon-info global-color-ca"})])],1)]),e._v(" "),a("div",{staticClass:"menu-right"},[a("el-button",{staticClass:"menu-btn",attrs:{size:"mini",type:"primary"},on:{click:e.save}},[e._v("保存")]),e._v(" "),this.formData.taskList.length?a("el-popconfirm",{staticClass:"menu-btn",attrs:{"popper-class":"close-popper",title:"确定退出当前页面吗？","confirm-button-text":"是","cancel-button-text":"否"},on:{confirm:e.close}},[a("el-button",{attrs:{slot:"reference",size:"mini"},slot:"reference"},[e._v("关闭")])],1):a("el-button",{attrs:{size:"mini"},on:{click:e.close}},[e._v("关闭")])],1)]),e._v(" "),a("flow-panel",{ref:"flowPanel",attrs:{loading:e.loading,data:e.flowData,"task-list":e.formData.taskList,"edit-able":e.editAble}}),e._v(" "),a("el-dialog",{attrs:{title:"保存工作流",visible:e.dialogVisable,width:"600px","append-to-body":""},on:{"update:visible":function(t){e.dialogVisable=t}}},[a("el-form",{ref:"formData",attrs:{model:e.formData,rules:e.rules,"label-position":"right","label-width":"100px"}},[a("el-form-item",{attrs:{prop:"name",label:"工作流名称"}},[a("el-input",{attrs:{placeholder:"须以字母、数字、下划线（_）组合，且不能以数字和下划线（_）开头，不超过100个字符",maxlength:"100"},model:{value:e.formData.name,callback:function(t){e.$set(e.formData,"name",t)},expression:"formData.name"}})],1),e._v(" "),a("el-form-item",{attrs:{prop:"description",label:"描述"}},[a("el-input",{attrs:{type:"textarea",placeholder:"请输入不超过200个字符",maxlength:"200"},model:{value:e.formData.description,callback:function(t){e.$set(e.formData,"description",t)},expression:"formData.description"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"用户组"}},[a("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择用户组",multiple:"",filterable:"",disabled:""},model:{value:e.formData.groupList,callback:function(t){e.$set(e.formData,"groupList",t)},expression:"formData.groupList"}},e._l(e.userGroupList,(function(e){return a("el-option",{key:e.id,attrs:{value:e.id,label:e.name}})})),1)],1),e._v(" "),a("el-tabs",[a("el-tab-pane",{attrs:{label:"调度配置"}},[a("dispatch-config",{ref:"dispatchConfig",attrs:{data:this.formData}})],1)],1)],1),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.dialogVisable=!1}}},[e._v("取 消")]),e._v(" "),a("el-tooltip",{attrs:{effect:"dark","popper-class":"tooltip-width",placement:"top",content:"history"===e.type?"保存即上线，如需下线，请自行切换至下线。并且，其中的历史任务（如果有）将不再在任务列表中显示，将只在工作流中显示":"保存即上线，如需下线，请自行切换至下线。"}},[a("el-button",{attrs:{type:"primary",disabled:e.submitDisabled},on:{click:e.submit}},[e._v("确 定")])],1)],1)],1),e._v(" "),a("el-dialog",{attrs:{title:"删除提示",visible:e.deleteVisible,width:"700px"},on:{"update:visible":function(t){e.deleteVisible=t}}},[a("div",{staticClass:"mb10"},[e._v("以下是删除的任务正在被依赖的信息：")]),e._v(" "),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.deleteLoading,expression:"deleteLoading"}],staticClass:"custom-table",staticStyle:{width:"100%"},attrs:{data:e.tableData,stripe:"",border:"","cell-style":{padding:"10px 0"}}},[a("el-table-column",{attrs:{prop:"curTaskName",label:"任务名称","min-width":"150"}}),e._v(" "),a("el-table-column",{attrs:{prop:"downTaskName",label:"下游任务","min-width":"150"}}),e._v(" "),a("el-table-column",{attrs:{prop:"downTaskOwner",label:"下游任务owner","min-width":"100"}})],1),e._v(" "),a("div",{staticClass:"mt10"},[a("span",[e._v("通知下游任务owner：")]),e._v(" "),a("el-radio-group",{model:{value:e.notify,callback:function(t){e.notify=t},expression:"notify"}},[a("el-radio",{attrs:{label:!0}},[e._v("是")]),e._v(" "),a("el-radio",{attrs:{label:!1}},[e._v("否")])],1)],1),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.deleteVisible=!1}}},[e._v("取 消")]),e._v(" "),a("el-button",{attrs:{type:"primary",disabled:e.btnDisabled},on:{click:e.deleteSave}},[e._v("确 定")])],1)],1)],1)},i=[],r=a("4bf8b"),o=a("b199"),s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"flow-panel"},[e.editAble?a("div",{staticClass:"leftDrag transition",class:{"left-close":!e.isOpen}},[a("div",{staticClass:"title"},[e._v("任务类型")]),e._v(" "),a("el-collapse",{staticClass:"content",model:{value:e.openTaskSheets,callback:function(t){e.openTaskSheets=t},expression:"openTaskSheets"}},e._l(e.taskSheets,(function(t,n){return a("div",{key:n},["数据接入类"!==t.title||e.isAdmin||e.currentUserGroup.dbc?a("el-collapse-item",{attrs:{name:t.title+n}},[a("template",{slot:"title"},[e._v("\n            "+e._s(t.title)+"\n            "),a("img",{class:{DD:"DD"===t.icon},staticStyle:{width:"25px",height:"25px","margin-left":"5px"},attrs:{src:e.icon[t.icon]}})]),e._v(" "),e._l(t.list,(function(t,i){return a("div",{key:i,staticClass:"dragger",attrs:{id:"dragger"+n+i,draggable:""},on:{dragstart:function(a){return e.dragStart(t)},dragend:e.dragEnd}},[a("el-tooltip",{attrs:{content:t.content,placement:"right"}},[a("Task",{attrs:{task:t}})],1)],1)}))],2):e._e()],1)})),0)],1):e._e(),e._v(" "),a("div",{staticClass:"btn-wrap"},[a("el-tooltip",{attrs:{content:"下载","open-delay":200,"popper-class":"tag-popper"}},[a("i",{staticClass:"el-icon-download btn-icon",on:{click:e.download}})]),e._v(" "),a("el-tooltip",{attrs:{content:"全屏","open-delay":200,"popper-class":"tag-popper"}},[a("i",{staticClass:"el-icon-rank btn-icon",on:{click:e.fullscreenFn}})]),e._v(" "),a("el-tooltip",{attrs:{content:"格式化","open-delay":200,"popper-class":"tag-popper"}},[a("svg-icon",{staticClass:"btn-icon",attrs:{"icon-class":"format"},on:{click:e.format}})],1)],1),e._v(" "),a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"right-content",attrs:{id:"right-content"}},[a("div",{class:["tree-arrow"],on:{click:function(t){e.isOpen=!e.isOpen}}},[a("i",{class:["icon-arrow-tree",e.isOpen?"el-icon-arrow-left":"el-icon-arrow-right"]})]),e._v(" "),a("div",{ref:"flowContent",class:["flow-content",e.fullscreen?"table-fullscreen":""],on:{dragover:function(e){return e.preventDefault()}}},[a("Slider",{ref:"slider",on:{zoom:e.handleZoom}}),e._v(" "),a("Graph",{ref:"graph",attrs:{data:e.data},on:{"node-click":e.handleNodeClick,"edge-connect":e.handleEdgeConnect,"edge-remove":e.handleEdgeRemove,"right-click":e.handleRightClick}}),e._v(" "),a("LabelList",{attrs:{"label-list":e.labelList},on:{open:e.openLabel,close:e.closeLabel}})],1),e._v(" "),a("el-tabs",{directives:[{name:"show",rawName:"v-show",value:e.isShowLog,expression:"isShowLog"}],staticClass:"log-content",attrs:{type:"card",closable:""},on:{"tab-remove":e.removeTab},model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},e._l(e.taskTabs,(function(t){return a("el-tab-pane",{key:t.title,attrs:{label:t.title,name:t.name}},[a("div",{staticClass:"log",domProps:{innerHTML:e._s(t.content)}})])})),1)],1),e._v(" "),a("el-drawer",{staticClass:"drawerDom",attrs:{title:e.dialogTitle,modal:!1,visible:e.dialogVisable,"before-close":e.cancel,size:"55%"}},[e.dialogVisable?a(e.taskType,{ref:"componentTask",tag:"component",staticClass:"workflowStep2",attrs:{data:e.taskData,source:"workflow"},on:{save:e.save,cancel:e.cancel}}):e._e(),e._v(" "),e.dialogVisable?a("i",{staticClass:"el-icon-minus minus",attrs:{title:"小窗"},on:{click:e.addLabelList}}):e._e(),e._v(" "),e.dialogVisable?a("div",{directives:[{name:"dragSize",rawName:"v-dragSize",value:e.dragSizeObj,expression:"dragSizeObj"}],staticClass:"drop",staticStyle:{right:"55%"}},[a("i",{staticClass:"el-icon-more icon"})]):e._e()],1)],1)},l=[],u=a("f151"),c=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{class:["task-state",e.taskInstanceStateClass,"task"]},[a("img",{staticClass:"logo",attrs:{src:e.logo,alt:e.task.name||e.task.label}}),e._v(" "),a("span",{staticClass:"label"},[e._v(e._s(e.task.name||e.task.label))])])},d=[],f=a("b893");function p(e){return v(e)||g(e)||m(e)||h()}function h(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function m(e,t){if(e){if("string"===typeof e)return b(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?b(e,t):void 0}}function g(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function v(e){if(Array.isArray(e))return b(e)}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var y={props:{task:{required:!0,type:Object,default:function(){return{}}}},computed:{logo:function(){var e,t=this;if(this.task.logo)return this.task.logo;var a="";return[].concat(p(f["c"]),p(f["j"])).find((function(e){return a=e.list.find((function(e){return e.templateCode===t.task.templateCode}))})),(null==(e=a)?void 0:e.logo)||"https://gw.alipayobjects.com/zos/bmw-prod/2010ac9f-40e7-49d4-8c4a-4fcf2f83033b.svg"},taskInstanceStateClass:function(){return this.task&&this.task.taskInstance?this.task.taskInstance.state:""}}},k=y,w=(a("96e0"),a("2877")),D=Object(w["a"])(k,c,d,!1,null,"61c44f7a",null),C=D.exports,S=a("7e61"),T=a("5f87"),O=a("73b8"),_=function(){var e=this,t=e.$createElement,a=e._self._c||t;return e.labelList.length>0?a("div",{staticClass:"label_wrap"},e._l(e.labelList,(function(t,n){return a("div",{key:t.name,staticClass:"label_item"},[a("div",{staticClass:"item_box",style:e.styleFn(n),on:{click:function(a){return e.$emit("open",t,n)}}},[a("i",{staticClass:"el-icon-close close",on:{click:function(t){return t.stopPropagation(),e.$emit("close",n)}}}),e._v(" "),a("div",e._b({staticClass:"text_box ellipsis",on:{mousemove:e.isShowTooltip,mouseleave:function(t){e.isTipDisabled=!0}}},"div",e.titleFn(t),!1),[e._v(e._s(t.ruleForm.name||t.labelName||""))])])])})),0):e._e()},L=[],$={name:"LabelList",props:{labelList:{type:Array,default:function(){return[]}}},data:function(){return{isTipDisabled:!1,colorList:["#0fabc0a8","#99c926b5","#c2d615bf","#ffa12da6","#6667aba6"]}},methods:{styleFn:function(e){var t={backgroundColor:"#6667aba6"},a=e%this.colorList.length;return t["backgroundColor"]=this.colorList[a],t},isShowTooltip:function(e){var t=e.target.clientWidth,a=e.target.scrollWidth;this.isTipDisabled=!(a>t&&t>100)},titleFn:function(e){var t=e.ruleForm.name||e.labelName||"",a={};return this.isTipDisabled||(a.title=t),a}}},x=$,N=(a("dfd6"),Object(w["a"])(x,_,L,!1,null,"13e6a3c8",null)),j=N.exports,I=a("2f62");function E(e){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E(e)}function P(e){return J(e)||A(e)||M(e)||H()}function H(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function M(e,t){if(e){if("string"===typeof e)return F(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?F(e,t):void 0}}function A(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function J(e){if(Array.isArray(e))return F(e)}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function q(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function V(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?q(Object(a),!0).forEach((function(t){G(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):q(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function G(e,t,a){return t=W(t),t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function W(e){var t=z(e,"string");return"symbol"===E(t)?t:String(t)}function z(e,t){if("object"!==E(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!==E(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var B={},K=a("e68b");u["a"].forEach((function(e){e.list.forEach((function(e){B[e.templateCode]=function(){return K("./".concat(e.templateCode,".vue"))}}))}));var R={name:"FlowPanel",components:V({Task:C,Graph:S["a"],Slider:O["a"],LabelList:j},B),props:{data:{type:Object,default:function(){return{nodes:[],edges:[]}}},editAble:{type:Boolean,default:!0},taskList:{type:Array,default:function(){return[]}},loading:{type:Boolean,default:!1}},data:function(){return{icon:{DI:a("02a0"),DD:a("eb84"),DT:a("f4bb"),Ot:a("2581")},isOpen:!0,addTaskNum:0,openTaskSheets:u["a"].map((function(e,t){return e.title+t})),taskSheets:u["a"],dialogTitle:"",dialogVisable:!1,taskType:"",taskData:{},activeTab:"",taskTabs:[],removeTabs:[],isShowLog:!1,websocket:null,isConnected:!1,fullscreen:!1,removeTaskIds:[],dataChangeNum:0,labelList:[],dialogDom:null,labelNum:1}},computed:V(V({},Object(I["c"])(["isAdmin","currentUserGroup"])),{},{dragSizeObj:function(){var e={};return e.sizeDom=this.dialogDom,e.sizeDomSeat="right",e.dropSeatType="right",e.sizeType={width:!0},e.limit={minWidth:"55%",maxWidth:"80%"},e}}),watch:{editAble:function(e){var t=this;this.$nextTick((function(){t.$refs.graph&&t.$refs.graph.dispose();var e=t.$refs.flowContent.offsetWidth,a=t.$refs.flowContent.offsetHeight;t.$refs.graph.init(e,a)}))},data:function(e){var t=this;if(this.dataChangeNum++,1===this.dataChangeNum&&this.$route.query.taskId){var a=e.nodes.find((function(e){return e.id===t.$route.query.taskId}));a&&this.$nextTick((function(){var e=t.$refs.graph.graph.getCellById(t.$route.query.taskId);t.handleNodeClick(e)}))}}},created:function(){this.initWebSocket()},mounted:function(){var e=this,t=this.$refs.flowContent.offsetWidth,a=this.$refs.flowContent.offsetHeight;this.$refs.graph.init(t,a),this.$nextTick((function(){document.addEventListener("keyup",(function(t){27===t.keyCode&&(e.fullscreen=!1,e.$nextTick((function(){var t=e.$refs.flowContent.offsetWidth,a=e.$refs.flowContent.offsetHeight;e.$refs.graph.graph.resize(t,a)})))}))})),this.dialogDom=document.querySelector(".drawerDom .el-drawer");var n=document.querySelector(".drawerDom .el-drawer__header .el-dialog__close");n.onclick=function(){e.closeLabelFn()}},destroyed:function(){this.websocket&&this.websocket.close()},methods:{getLabel:function(e){var t="";return u["a"].some((function(a){return a.list.some((function(a){if(a.templateCode===e)return t=a.label,!0}))})),t},openLabel:function(e,t){var a=this;this.dragEnd(),this.taskData={},this.taskType=e.ruleForm.templateCode,this.dialogTitle=e.dialogTitle,this.$nextTick((function(){var t=a.$refs.componentTask;Object.keys(e).forEach((function(a){t[a]=e[a]})),"PythonShell"===e.ruleForm.templateCode?a.resetSql(t,e.seniorForm.cmds):"SPARKJAR"===e.ruleForm.templateCode?a.resetSql(t,e.ruleForm.mainClassArgs):a.resetSql(t,e.content)}))},addLabelList:function(){var e=this.$refs.componentTask,t=f["b"](e["_data"]);if(t.onceType=e.onceType,t.labelName=e.labelName,t.dialogTitle=this.dialogTitle,t.onceType){var a=this.labelList.findIndex((function(e){return e.onceType===t.onceType}));this.labelList.splice(a,1,t)}else t.onceType=Math.random()+"",t.ruleForm.name||(t.labelName="编辑中 (".concat(this.labelNum,") ..."),this.labelNum++),this.labelList.push(t);this.dialogVisable=!1},dragStart:function(e){this.taskType=e.templateCode,this.taskData={},this.dialogTitle="创建".concat(e.label)},dragEnd:function(){this.dialogVisable=!0},formatGraphData:function(e){var t=this,a=0;if(e.id){var n=e.id+"",i="id";n.indexOf("addTask")>-1&&(e.taskKey=e.id,i="taskKey");var r=this.taskList.findIndex((function(t){return t[i]+""===e[i]+""})),o=V({},e);n.indexOf("addTask")>-1&&delete o.id,this.taskList[r]=o;var s=this.$refs.graph.graph.getCellById(e.id+"");s.setData(e)}else{if(this.taskList.some((function(t){return t.name===e.name})))return;e.taskKey="addTask"+this.addTaskNum,this.taskList.push(e);var l={id:"addTask"+this.addTaskNum,x:a,shape:"card",data:V({id:"addTask"+this.addTaskNum},e)};this.$refs.graph.graph.addNode(l)}var u=[],c=e.id||e.taskKey,d=this.$refs.graph.graph.getIncomingEdges(c);d&&d.length&&d.forEach((function(e){"light-dash-edge"===e.shape&&u.push(e.source.cell),t.$refs.graph.graph.removeEdge(e)})),e.eventDepends.length&&e.eventDepends.forEach((function(n){var i=n.taskId?n.taskId+"":n.taskKey;if(!t.$refs.graph.graph.hasCell(i)){a+=220;var r={id:i,x:a,shape:"card",data:V(V({},n),{},{id:i,name:n.dependId,templateCode:n.templateCode,isHistoryTask:!0})};t.$refs.graph.graph.addNode(r)}var o="light-dash-edge",s=t.taskList.map((function(e){return e.id?e.id+"":e.taskKey?e.taskKey:void 0}));s.includes(i)&&(o="light-edge");var l={source:i,target:e.id||e.taskKey,shape:o};t.$refs.graph.graph.addEdge(l)})),u.length&&u.forEach((function(e){var a=t.$refs.graph.graph.getOutgoingEdges(e);null===a&&t.$refs.graph.graph.removeNode(e)})),this.updateData(),this.$refs.graph.render()},handleZoom:function(e){this.$refs.graph.zoomFn(e)},save:function(e){this.addTaskNum++,this.formatGraphData(e),this.dialogVisable=!1},closeLabelFn:function(){var e=this.$refs.componentTask;if(e&&e.onceType){var t=this.labelList.findIndex((function(t){return t.onceType===e.onceType}));t>=0&&this.closeLabel(t)}},closeLabel:function(e){this.labelList.splice(e,1)},cancel:function(){this.dialogVisable=!1},copyNode:function(e){var t=V({},e);delete t.id,t.isCopy=!0,t.runtimeConfig="string"===typeof t.runtimeConfig?t.runtimeConfig:JSON.stringify(t.runtimeConfig),t.inputDataset="string"===typeof t.inputDataset?t.inputDataset:JSON.stringify(t.inputDataset),t.outputDataset="string"===typeof t.outputDataset?t.outputDataset:JSON.stringify(t.outputDataset),t.dependTypes="string"===typeof t.dependTypes?t.dependTypes:JSON.stringify(t.dependTypes),t.triggerParam="string"===typeof t.triggerParam?t.triggerParam:JSON.stringify(t.triggerParam),t.eventDepends="string"===typeof t.eventDepends?t.eventDepends:JSON.stringify(t.eventDepends),t.canEdit||(t.canEdit=!0),this.taskData=t,this.taskType=t.templateCode,this.dialogTitle="创建".concat(this.getLabel(t.templateCode)),this.dialogVisable=!0},removeNode:function(e){var t=this;this.$confirm("确定删除此节点?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){var a=t.data.edges.filter((function(t){return t.source===e.id})),n=a.map((function(e){return e.target}));n.length&&n.forEach((function(a){var n=t.$refs.graph.graph.getCellById(a),i=n.getData();"string"===typeof i.eventDepends&&(i.eventDepends=JSON.parse(i.eventDepends),i.dependTypes=JSON.parse(i.dependTypes));var r=e.id.indexOf("addTask")>-1?"taskKey":"taskId";i.eventDepends=i.eventDepends.filter((function(t){return t[r]!==e.id})),0===i.eventDepends.length&&i.dependTypes.includes("event")&&(i.dependTypes=i.dependTypes.filter((function(e){return"event"!==e}))),n.setData(i);var o=t.taskList.find((function(e){return(e.id||e.taskKey)===a}));o&&(o.dependTypes=i.dependTypes,o.eventDepends=i.eventDepends)}));var i=t.data.edges.filter((function(t){return t.target===e.id})),r=t.data.nodes.filter((function(e){return i.findIndex((function(t){return t.source===e.data.id}))>-1&&e.data.isHistoryTask}));r.length&&r.forEach((function(e){t.$refs.graph.graph.removeNode(e.data.id)})),t.$refs.graph.graph.removeNode(e.id),t.updateData();var o=t.taskList.findIndex((function(a){a.id===e.id&&t.data.id&&t.removeTaskIds.push(a.id);var n=a.id||a.taskKey;return n===e.id}));-1!==o&&t.taskList.splice(o,1),t.$message.success("删除成功!")})).catch((function(){}))},updateData:function(){var e=this;this.data.nodes=[],this.data.edges=[];var t=this.$refs.graph.graph.getCells();t.forEach((function(t){if(t.isNode()){var a=t.getData();e.data.nodes.push({id:a.id,shape:t.shape,data:V({},a)})}else t.isEdge()&&e.data.edges.push({source:t.source.cell,target:t.target.cell,shape:t.shape})}))},initWebSocket:function(){var e=this;if("undefined"===typeof WebSocket)this.$message.error("您的浏览器不支持socket");else if(null===this.websocket){var t="https://ds-task.datacake.cloud".split("//")[1],a="wss://".concat(t,"/websocket/task/debug"),n=Object(T["a"])();this.websocket=new WebSocket(a,n),this.websocket.onopen=function(t){e.onOpen(t)},this.websocket.onmessage=function(t){e.onMessage(t)},this.websocket.onclose=function(t){e.onClose(t)},this.websocket.onerror=function(t){e.onError(t)}}},onOpen:function(e){console.log("onOpen...",e)},onMessage:function(e){var t=JSON.parse(e.data);if(0===t.code){var a=t.data;if(a&&("SYSTEM_MESSAGE"===a.type&&a.data.message.indexOf("连接成功")>-1&&(this.isConnected=!0),"TASK_MESSAGE"===a.type&&this.pushTaskMsg(a.data),"STATUS_INFO"===a.type)){var n=this.data.nodes.find((function(e){return e.id===a.data.taskId+""}));n.data.state=a.data.status,this.$refs.graph.render()}}else this.$notify.error({title:"错误",message:t.message})},onSend:function(e){var t=this;this.isConnected&&(this.websocket?this.websocket.send(JSON.stringify(e)):(this.initWebSocket(),setTimeout((function(){t.websocket.send(JSON.stringify(e))}),3e3)))},onClose:function(e){console.log("onClose...",e),this.websocket.close()},onError:function(e){console.log("onError...",e)},pushTaskMsg:function(e){var t=this.taskTabs.find((function(t){return t.name+""===e.taskId+""}));t&&(t.content+="<br/>"+e.message)},runNode:function(e,t){var a=this;if(this.isShowLog||(this.isShowLog=!0),t){var n=this.taskTabs.map((function(e){return e.name}));n.includes(e.id)||this.taskTabs.push({title:e.name,name:e.id,content:"正在运行中..."});var i={type:"DEBUG",data:[e]};this.onSend(i),this.activeTab=e.id}else{var r={type:"SHUTDOWN",data:[e.id]};this.onSend(r)}var o=this.data.nodes.find((function(t){return t.id===e.id}));o.data.state=t?"waiting":"failed",o.data.isRunNode=t,this.$refs.graph.render(),setTimeout((function(){a.scrollToBottom()}),1e3)},runNodes:function(e,t,a){var n=this,i=this.findNodes(e.id,a);this.isShowLog||(this.isShowLog=!0),this.activeTab=e.id;var r=this.taskList.filter((function(e){return i.includes(e.id)})),o=this.taskTabs.map((function(e){return e.name}));if(t){var s=[];r.forEach((function(e){o.includes(e.id)||n.taskTabs.push({title:e.name,name:e.id,content:"正在运行中..."}),i.includes(e.id)&&s.push(e)}));var l={type:"DEBUG",data:s};this.onSend(l)}else{var u={type:"SHUTDOWN",data:i};this.onSend(u)}i.forEach((function(e){var a=n.data.nodes.find((function(t){return t.id===e}));a.data.state=t?"waiting":"failed"}));var c=this.data.nodes.find((function(t){return t.id===e.id}));c.data["source"===a?"isRunNodeDown":"isRunNodeUp"]=t,this.$refs.graph.render(),setTimeout((function(){n.scrollToBottom()}),1e3)},runNodeDown:function(e,t){this.runNodes(e,t,"source")},runNodeUp:function(e,t){this.runNodes(e,t,"target")},findNodes:function(e,t){var a="source"===t?"target":"source",n=[e],i=this.data.edges;function r(e){e.forEach((function(e){var o=i.filter((function(n){return n[t]===e&&-1===n[a].indexOf("addTask")&&"light-edge"===n.shape})).map((function(e){return e[a]}));o.length&&(n.push.apply(n,P(o)),r(o))}))}return r([e]),n},watchLog:function(e){var t=this,a=this.taskTabs.find((function(t){return t.name===e.id}));if(a)this.activeTab=e.id;else{var n=this.removeTabs.find((function(t){return t.name===e.id}));n?(this.isShowLog=!0,this.taskTabs.push(n),this.activeTab=e.id):this.$message.warning("此节点没有运行过，暂无日志")}setTimeout((function(){t.scrollToBottom()}),1e3)},handleRightClick:function(e,t,a){this[e](t,a)},handleEdgeConnect:function(e,t){var a=this.taskList.find((function(e){return e.name===t.name})),n=this.$refs.graph.graph.getCellById(t.id);if(a){var i,r,o;if("string"===typeof a.dependTypes&&(a.dependTypes=JSON.parse(a.dependTypes),a.eventDepends=JSON.parse(a.eventDepends)),a.dependTypes.includes("event")||a.dependTypes.push("event"),e.isHistoryTask)i={dependId:e.dependId,granularity:e.granularity,metadataId:e.metadataId,dateCalculationParam:e.dateCalculationParam,unitOffset:e.unitOffset,useDateCalcuParam:e.useDateCalcuParam};else"string"===typeof e.outputDataset?(r=JSON.parse(e.outputDataset).lenght?JSON.parse(e.outputDataset)[0].metadata:"",o=JSON.parse(e.triggerParam).outputGranularity):(r=e.outputDataset.length?e.outputDataset[0].metadata:"",o=e.triggerParam.outputGranularity),i={dependId:e.name,granularity:o,metadataId:r?"".concat(r.db,".").concat(r.table,"@").concat(r.region):"",dateCalculationParam:{},unitOffset:0,useDateCalcuParam:!1};e.id.indexOf("addTask")>-1?i.taskKey=e.id:i.taskId=e.id;var s=a.eventDepends.map((function(e){return e.taskId?e.taskId:e.taskKey?e.taskKey:void 0}));s.includes(i.taskId)||s.includes(i.taskKey)||a.eventDepends.push(i),n.setData(a)}this.updateData()},handleEdgeRemove:function(e,t){var a=e,n=this.$refs.graph.graph.getCellById(t),i=n.getData();"string"===typeof i.eventDepends&&(i.eventDepends=JSON.parse(i.eventDepends),i.dependTypes=JSON.parse(i.dependTypes));var r=a.indexOf("addTask")>-1?"taskKey":"taskId";i.eventDepends=i.eventDepends.filter((function(e){return e[r]+""!==a})),0===i.eventDepends.length&&i.dependTypes.includes("event")&&(i.dependTypes=i.dependTypes.filter((function(e){return"event"!==e}))),n.setData(i);var o=this.taskList.find((function(e){return e.id===i.id}));o&&(o.dependTypes=i.dependTypes,o.eventDepends=i.eventDepends),this.updateData()},handleNodeClick:function(e){var t=this,a=e.getData();if(a.isHistoryTask){var n=this.$router.resolve({path:"/task/detail",query:{id:a.id,name:a.name}}),i=n.href;window.open(i,"_blank")}else{var r=this.labelList.findIndex((function(e){return e.ruleForm.name===a.name}));r>-1||(a.runtimeConfig="string"===typeof a.runtimeConfig?a.runtimeConfig:JSON.stringify(a.runtimeConfig),a.inputDataset="string"===typeof a.inputDataset?a.inputDataset:JSON.stringify(a.inputDataset),a.outputDataset="string"===typeof a.outputDataset?a.outputDataset:JSON.stringify(a.outputDataset),a.dependTypes="string"===typeof a.dependTypes?a.dependTypes:JSON.stringify(a.dependTypes),a.triggerParam="string"===typeof a.triggerParam?a.triggerParam:JSON.stringify(a.triggerParam),a.eventDepends="string"===typeof a.eventDepends?a.eventDepends:JSON.stringify(a.eventDepends),void 0===a.canEdit&&(a.canEdit=!0),this.taskData=a),this.taskType=a.templateCode,this.dialogTitle="编辑"+this.getLabel(a.templateCode),this.dialogVisable=!0,r>-1&&(this.taskData={},this.$nextTick((function(){var e=t.$refs.componentTask,a=t.labelList[r];e.onceType=Math.random()+"",a.labelName&&(e.labelName=a.labelName),Object.keys(a).forEach((function(t){e[t]=a[t]})),"PythonShell"===a.ruleForm.templateCode?t.resetSql(e,a.seniorForm.cmds):"SPARKJAR"===a.ruleForm.templateCode?t.resetSql(e,a.ruleForm.mainClassArgs):t.resetSql(e,a.content)})))}},resetSql:function(e,t){var a;t=t||"",null==(a=e.$refs.monaco)||a.setCode(t)},removeTab:function(e){var t=this;this.$confirm("此操作会停止打印该任务的运行日志，是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){var a={type:"SHUTDOWN",data:[e]};t.onSend(a);var n=t.taskTabs,i=n.find((function(t){return t.name===e}));t.removeTabs.push(i),t.taskTabs=n.filter((function(t){return t.name!==e})),t.taskTabs.length?t.activeTab===e&&(t.activeTab=t.taskTabs[0].name):t.isShowLog=!1})).catch((function(){}))},scrollToBottom:function(){var e=document.getElementById("right-content");e&&(e.scrollTop=e.scrollHeight)},download:function(){this.$refs.graph.exportPng()},fullscreenFn:function(){var e=this;this.fullscreen=!this.fullscreen,this.$nextTick((function(){var t=e.$refs.flowContent.offsetWidth,a=e.$refs.flowContent.offsetHeight;e.$refs.graph.graph.resize(t,a),e.$message("按ESC可退出全屏")}))},format:function(){var e=this;this.$refs.graph.dispose(),this.$nextTick((function(){e.data.nodes.forEach((function(e){e.data.state&&delete e.data.state}));var t=e.$refs.flowContent.offsetWidth,a=e.$refs.flowContent.offsetHeight;e.$refs.graph.init(t,a),e.$refs.slider.value=100}))}}},U=R,Z=(a("5c09"),a("7359"),Object(w["a"])(U,s,l,!1,null,"610b002c",null)),Y=Z.exports,Q=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"dispatch-config"},[a("div",{staticClass:"schedule-wrap"},[["minutely"===e.data.granularity?a("el-select",{staticStyle:{width:"120px"},attrs:{disabled:e.isShowCron},model:{value:e.fromMinute,callback:function(t){e.fromMinute=t},expression:"fromMinute"}},e._l(e.fromMinuteList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1):"hourly"===e.data.granularity?a("el-select",{staticStyle:{width:"120px"},attrs:{disabled:e.isShowCron},model:{value:e.fromHour,callback:function(t){e.fromHour=t},expression:"fromHour"}},e._l(e.fromHourList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1):a("span",[e._v("每")])],e._v(" "),a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},on:{change:e.changeGranularity},model:{value:e.data.granularity,callback:function(t){e.$set(e.data,"granularity",t)},expression:"data.granularity"}},e._l(e.granularityList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"minutely"===e.data.granularity&&e.fromMinute>1||"hourly"===e.data.granularity&&1===e.fromHour,expression:"(data.granularity === 'minutely' && fromMinute > 1) || (data.granularity === 'hourly' && fromHour === 1)"}],staticStyle:{display:"inline-block"}},[e._v("\n      "+e._s("minutely"===e.data.granularity?"从":"在")+"\n      "),"minutely"===e.data.granularity?a("el-select",{attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.fromMinute,callback:function(t){e.$set(e.data.cronConfig,"fromMinute",t)},expression:"data.cronConfig.fromMinute"}},e._l(e.forMinuteList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1):e._e(),e._v(" "),"hourly"===e.data.granularity?a("el-select",{attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.minute,callback:function(t){e.$set(e.data.cronConfig,"minute",t)},expression:"data.cronConfig.minute"}},e._l(e.forMinuteList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1):e._e()],1),e._v(" "),"weekly"===e.data.granularity?[e._v("\n      的\n      "),a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.dayOfWeek,callback:function(t){e.$set(e.data.cronConfig,"dayOfWeek",t)},expression:"data.cronConfig.dayOfWeek"}},e._l(e.weekList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)]:e._e(),e._v(" "),"monthly"===e.data.granularity?[e._v("\n      的 第\n      "),a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.dayOfMonth,callback:function(t){e.$set(e.data.cronConfig,"dayOfMonth",t)},expression:"data.cronConfig.dayOfMonth"}},e._l(e.dayList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)]:e._e(),e._v(" "),!["minutely","hourly"].includes(e.data.granularity)||"hourly"===e.data.granularity&&1!==e.fromHour?[e._v("\n      "+e._s("hourly"===e.data.granularity?"从":"在")+"\n      "),"hourly"===e.data.granularity?a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.fromHour,callback:function(t){e.$set(e.data.cronConfig,"fromHour",t)},expression:"data.cronConfig.fromHour"}},e._l(e.hourList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1):a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.hour,callback:function(t){e.$set(e.data.cronConfig,"hour",t)},expression:"data.cronConfig.hour"}},e._l(e.hourList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),e._v("\n      :\n      "),a("el-select",{staticStyle:{width:"100px"},attrs:{disabled:e.isShowCron},model:{value:e.data.cronConfig.minute,callback:function(t){e.$set(e.data.cronConfig,"minute",t)},expression:"data.cronConfig.minute"}},e._l(e.minuteList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)]:e._e(),e._v("\n    开始调度\n  ")],2),e._v(" "),a("el-checkbox",{staticClass:"mt10",on:{change:e.changeCron},model:{value:e.isShowCron,callback:function(t){e.isShowCron=t},expression:"isShowCron"}},[e._v("显示cron表达式")]),e._v(" "),e.isShowCron?a("span",{staticClass:"cron"},[e._v("\n    "+e._s(e.crontab?e.crontab:"")+"\n  ")]):e._e()],1)},X=[];function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ae(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?te(Object(a),!0).forEach((function(t){ne(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):te(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function ne(e,t,a){return t=ie(t),t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function ie(e){var t=re(e,"string");return"symbol"===ee(t)?t:String(t)}function re(e,t){if("object"!==ee(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!==ee(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var oe={name:"DispatchConfig",props:{data:{type:Object,default:function(){return{}}}},data:function(){for(var e=[],t=0;t<60;t++)e.push({label:t<10?"0"+t:t,value:t});for(var a=[],n=1;n<32;n++)a.push({label:n<10?"0"+n:n,value:n});return{isShowCron:!1,fromMinute:5,fromHour:1,crontab:"",fromMinuteList:[{label:"每 5",value:5},{label:"每 6",value:6},{label:"每 10",value:10},{label:"每 12",value:12},{label:"每 15",value:15},{label:"每 20",value:20},{label:"每 30",value:30}],fromHourList:[{label:"每 1",value:1},{label:"每 2",value:2},{label:"每 3",value:3},{label:"每 4",value:4},{label:"每 5",value:5},{label:"每 6",value:6},{label:"每 8",value:8},{label:"每 12",value:12}],granularityList:[{label:"分钟",value:"minutely"},{label:"小时",value:"hourly"},{label:"天",value:"daily"},{label:"周",value:"weekly"},{label:"月",value:"monthly"}],minuteList:e,weekList:[{label:"星期一",value:1},{label:"星期二",value:2},{label:"星期三",value:3},{label:"星期四",value:4},{label:"星期五",value:5},{label:"星期六",value:6},{label:"星期日",value:7}],dayList:a}},computed:{forMinuteList:function(){var e=[],t=0;"minutely"===this.data.granularity?t=this.fromMinute:"hourly"===this.data.granularity&&(t=60);for(var a=0;a<t;a++)e.push({label:"小时的第 ".concat(a," 分钟"),value:a});return e},hourList:function(){var e=[],t=0;t="hourly"===this.data.granularity?this.fromHour:24;for(var a=0;a<t;a++)e.push({label:a<10?"0"+a:a,value:a});return e}},watch:{data:{handler:function(e){"minutely"===e.granularity&&this.fromMinute>1&&(this.fromMinute=e.cronConfig.minute),"hourly"===e.granularity&&(this.fromHour=e.cronConfig.hour)},immediate:!0,deep:!0},fromMinute:function(e){"minutely"===this.data.granularity&&e>1&&(this.data.cronConfig.minute=e)},fromHour:function(e){"hourly"===this.data.granularity&&(this.data.cronConfig.hour=e)}},methods:{changeGranularity:function(e){"minutely"===e?(this.data.cronConfig.minute=5,this.data.cronConfig.fromMinute=0):"hourly"===e?(this.data.cronConfig.hour=1,this.data.cronConfig.minute=0):(this.data.cronConfig.hour=0,this.data.cronConfig.minute=0)},changeCron:function(e){var t=this;e&&("minutely"===this.data.granularity&&this.fromMinute>1&&(this.data.cronConfig.minute=this.fromMinute),"hourly"===this.data.granularity&&(this.data.cronConfig.hour=this.fromHour),Object(r["g"])(ae({granularity:this.data.granularity},this.data.cronConfig)).then((function(e){var a=e.data;t.crontab=a})))}}},se=oe,le=Object(w["a"])(se,Q,X,!1,null,"67a7aac7",null),ue=le.exports;a("7e3c");function ce(e){return ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ce(e)}function de(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function fe(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?de(Object(a),!0).forEach((function(t){pe(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):de(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function pe(e,t,a){return t=he(t),t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function he(e){var t=me(e,"string");return"symbol"===ce(t)?t:String(t)}function me(e,t){if("object"!==ce(e)||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!==ce(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var ge={components:{FlowPanel:Y,DispatchConfig:ue},data:function(){var e=function(e,t,a){var n=/^[a-zA-Z0-9][-_a-zA-Z0-9]*$/;n.test(t)?a():a(new Error("名字只能包含a-z,A-Z,0-9或-或_；开始需为字符，最多100个字符"))};return{workflowId:this.$route.query.id,version:this.$route.query.version,type:this.$route.query.type,loading:!1,name:"创建工作流",dialogVisable:!1,relations:[],editAble:!0,ownerList:[],collaboratorsList:[],flowData:{nodes:[],edges:[]},formData:{source:this.$route.query.type,name:"",description:"",owner:"",collaborators:[],groupList:[],granularity:"daily",cronConfig:{dayOfWeek:1,dayOfMonth:1,hour:0,minute:0,fromHour:0,fromMinute:0},taskList:[]},userGroupList:[],rules:{name:[{required:!0,message:"请输入工作流名称",trigger:["blur","change"]},{validator:e,trigger:["blur","change"]}],owner:[{required:!0,message:"请输入负责人",trigger:"blur"}],collaborators:[{required:!0,message:"请输入协作人",trigger:"blur"}]},submitDisabled:!1,selectLoading:!1,deleteVisible:!1,deleteLoading:!1,tableData:[],notify:!0,btnDisabled:!1}},created:function(){this.workflowId||(this.formData.owner=this.$store.getters.userInfo.userId),this.remoteMethod(this.formData.owner,"ownerList"),this.getUserGroup()},mounted:function(){if(this.workflowId&&this.getData(),"history"===this.type){this.editAble=!1;var e=JSON.parse(localStorage.getItem("tasks"));e&&this.getTasksList(e)}},methods:{getUserGroup:function(){this.formData.groupList=this.$store.getters["user/currentUserGroup"].id?[this.$store.getters["user/currentUserGroup"].id]:[],this.userGroupList=this.$store.getters["user/userGroupList"]},remoteMethod:function(e,t){var a=this;""!==e&&(this.selectLoading=!0,Object(o["Y"])(e).then((function(e){var n=e.data;a.selectLoading=!1,a[t]=n})))},getTasksList:function(e,t){var a=this;this.loading=!0,Object(r["q"])(e).then((function(t){var n=t.data;a.formData.taskList=n,a.getRelation(e)}))},close:function(){this.$router.push("/task/workflow")},save:function(){this.dialogVisable=!0},submit:function(){var e=this;this.$refs.formData.validate((function(t){if(t){e.formData.taskList=e.$refs.flowPanel.taskList,e.formData.taskList.forEach((function(t){t.eventDepends="string"===typeof t.eventDepends?JSON.parse(t.eventDepends):t.eventDepends,t.eventDepends.forEach((function(t){t.taskKey&&(t.granularity=e.formData.granularity)}))}));var a,n,i=e.$refs.flowPanel.removeTaskIds;if(i.length)e.showDeleteDialog(i);else e.submitDisabled=!0,e.formData.id?(a=Object(r["e"])(e.formData),n="编辑成功"):(a=Object(r["a"])(e.formData),n="新建成功"),a.then((function(t){e.$message.success(n),e.$router.push("/task/workflow")})).finally((function(){e.submitDisabled=!1}))}}))},showDeleteDialog:function(e){var t=this;this.deleteVisible=!0,this.deleteLoading=!0,Object(r["h"])({taskIds:e.join(",")}).then((function(e){var a=e.data;t.tableData=a,0===t.tableData.length&&(t.notify=!1),t.deleteLoading=!1}))},deleteSave:function(){var e=this;this.btnDisabled=!0,Object(r["e"])(fe(fe({},this.formData),{},{notify:this.notify})).then((function(t){e.$message.success("编辑成功"),e.$router.push("/task/workflow")})).finally((function(){e.btnDisabled=!1}))},getData:function(){var e=this;this.loading=!0,Object(r["s"])({workflowId:this.workflowId,version:this.version}).then((function(t){var a=t.data;"history"===a.source&&0===a.status&&(e.editAble=!1),e.formData={id:a.id,originWorkflowVersionId:a.workflowVersionId,source:e.$route.query.type,name:a.name,description:a.description,owner:a.owner,collaborators:a.collaborators,groupList:a.groupList.map((function(e){return e.id})),granularity:a.granularity,cronConfig:a.cronConfig,taskList:a.taskList};var n=a.taskList.map((function(e){return{taskId:e.id,version:e.currentVersion}}));e.getRelation(n)}))},getRelation:function(e){var t=this;Object(r["r"])({tasks:e}).then((function(e){var a=e.data;t.flowData={nodes:[],edges:[]},a.nodeList.forEach((function(e){var a={},n=t.formData.taskList.find((function(t){return t.id===e.taskId}));if(n)n.id=n.id+"",a=fe(fe({},n),{},{isHistoryTask:e.isOutside});else{var i={};t.formData.taskList.forEach((function(t){var a=JSON.parse(t.eventDepends),n=a.find((function(t){return t.taskId===e.taskId+""}));n&&(i=n)})),a=fe(fe({},i),{},{id:e.taskId+"",name:e.taskName,templateCode:e.templateCode,isHistoryTask:e.isOutside})}a.canEdit=!t.noEdit(t.formData),t.flowData.nodes.push({id:e.taskId+"",shape:"card",data:a})})),a.relation.forEach((function(e){t.flowData.edges.push({source:e.source+"",target:e.target+"",shape:e.sourceIsOutside?"light-dash-edge":"light-edge"})})),t.loading=!1}))},noEdit:function(e){if(this.$store.getters.userInfo){if(this.$store.getters.userInfo.isAdmin)return!1;var t=e.groupList.map((function(e){return e.id})),a=this.$store.getters.userInfo.groupIds.split(","),n=a.some((function(e){return t.includes(Number(e))}));return e.owner!==this.$store.getters.userInfo.userId&&!e.collaborators.includes(this.$store.getters.userInfo.userId)&&!n}return!1}}},ve=ge,be=(a("b346"),Object(w["a"])(ve,n,i,!1,null,"6f21c1a5",null));t["default"]=be.exports},"5c09":function(e,t,a){"use strict";a("23e3")},7359:function(e,t,a){"use strict";a("10f0")},"73b8":function(e,t,a){"use strict";var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"slider-wrap"},[a("i",{class:["el-icon-plus","pointer",e.value>=200?"not-allowed":""],on:{click:e.add}}),e._v(" "),a("el-slider",{staticClass:"slider",attrs:{vertical:"",step:10,min:10,max:200,"format-tooltip":e.format,height:"200px"},model:{value:e.value,callback:function(t){e.value=t},expression:"value"}}),e._v(" "),a("i",{class:["el-icon-minus","pointer",e.value<=10?"not-allowed":""],on:{click:e.reduce}})],1)},i=[],r={name:"Slider",data:function(){return{value:100}},watch:{value:function(e,t){e>t?this.$emit("zoom","add"):this.$emit("zoom","reduce")}},methods:{format:function(e){return e+"%"},add:function(){this.value+=10},reduce:function(){this.value-=10}}},o=r,s=(a("4aa9"),a("2877")),l=Object(s["a"])(o,n,i,!1,null,"d45fb91a",null);t["a"]=l.exports},"96e0":function(e,t,a){"use strict";a("fa13")},b346:function(e,t,a){"use strict";a("e4c0")},dfd6:function(e,t,a){"use strict";a("53d2")},e4c0:function(e,t,a){},e68b:function(e,t,a){var n={"./DataMigration.vue":["59b6","chunk-commons","chunk-5a46f722","chunk-274f85e6"],"./Db2Hive.vue":["8948","chunk-commons","chunk-5a46f722","chunk-894c7032"],"./File2Lakehouse.vue":["c927","chunk-commons","chunk-5a46f722","chunk-2d212b99","chunk-2d0e17c3","chunk-6b124136"],"./Hive2Clickhouse.vue":["bb88","chunk-commons","chunk-5a46f722","chunk-2d212b99","chunk-4ed9433e"],"./Hive2Doris.vue":["8d7d","chunk-commons","chunk-5a46f722","chunk-2d212b99","chunk-66bcf1dc"],"./Hive2Hive.vue":["4c4c","chunk-commons","chunk-5a46f722","chunk-0e6381cd"],"./Hive2Mysql.vue":["fc6c","chunk-commons","chunk-5a46f722","chunk-2d212b99","chunk-358ec27e"],"./Hive2Redis.vue":["119c","chunk-commons","chunk-5a46f722","chunk-1cc0a2f6"],"./Hive2Redshift.vue":["92c3","chunk-commons","chunk-5a46f722","chunk-2bec964a"],"./Hive2Sharestore.vue":["2239","chunk-commons","chunk-5a46f722","chunk-14422c39"],"./MergeSmallFiles.vue":["46a7","chunk-commons","chunk-9351dab0"],"./Metis2Hive.vue":["ef0e","chunk-commons","chunk-5a46f722","chunk-702f0c4a"],"./Mysql2Hive.vue":["c280","chunk-commons","chunk-5a46f722","chunk-58a4bc1e"],"./Mysql2Hudi.vue":["9496","chunk-commons","chunk-5a46f722","chunk-2b1f3608"],"./PythonShell.vue":["34b7","chunk-commons","chunk-5a46f722","chunk-1611cc92"],"./SPARKJAR.vue":["85d3","chunk-commons","chunk-5a46f722","chunk-6edab1ba"],"./Step2Hive2File.vue":["375e","chunk-commons","chunk-5a46f722","chunk-f4ecbdd4"],"./Step2TrainingModel.vue":["d922","chunk-commons","chunk-5a46f722","chunk-1148a660"],"./StreamingJAR.vue":["cfd5","chunk-commons","chunk-5a46f722","chunk-face392c"],"./StreamingSQL.vue":["3eb3","chunk-commons","chunk-5a46f722","chunk-772a5b07"]};function i(e){var t=n[e];return t?Promise.all(t.slice(1).map(a.e)).then((function(){var e=t[0];return a(e)})):Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}))}i.keys=function(){return Object.keys(n)},i.id="e68b",e.exports=i},fa13:function(e,t,a){}}]);